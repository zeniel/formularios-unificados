{
  "info": {
    "_postman_id": "qadmin-001",
    "name": "Questionário Admin API",
    "description": "API do sistema de Formulários Unificados CNJ do CNJ.\n\nEste serviço roda na porta 3000 e expõe endpoints para autenticação via credencial corporativa e consulta de dados do corporativo.\n\n## Autenticação\n\nA maioria dos endpoints requer sessão ativa. O fluxo é:\n1. Portal corporativo redireciona para `/auth/callback?c=CREDENCIAL` (GET ou POST)\n2. Sistema valida credencial e cria cookie `qadmin_session`\n3. Requests subsequentes enviam o cookie automaticamente\n\nO cookie `qadmin_session` tem TTL de 8 horas.\n\n## Perfis\n\n| Perfil | Permissões |\n|--------|------------|\n| ADMINISTRADOR | Acesso total |\n| PESQUISADOR | Criar/editar questionários |\n| VISUALIZADOR | Apenas leitura |\n| PESQUISADO | Responder formulários |",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:3000",
      "type": "string"
    },
    {
      "key": "corporativoUrl",
      "value": "https://www.cnj.jus.br/corporativo",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Autenticação",
      "description": "Fluxo de autenticação via credencial corporativa CNJ (SCA).\n\nA credencial é uma string Base64 + hash MD5 com separador `SEPARADORCREDENCIALCNJ`.\n\nConteúdo da credencial: seqUsuario, seqOrgao, seqPerfil, timeToLive.\n\nAceita tanto GET quanto POST (o portal CNJ pode enviar de ambas as formas).",
      "item": [
        {
          "name": "Login (callback credencial - GET)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/auth/callback?c=CREDENCIAL_BASE64_AQUI",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "callback"],
              "query": [
                {
                  "key": "c",
                  "value": "CREDENCIAL_BASE64_AQUI",
                  "description": "Credencial corporativa CNJ."
                }
              ]
            },
            "description": "Endpoint de callback chamado pelo portal corporativo CNJ.\n\nRecebe a credencial no query param `c`, valida, cria sessão e redireciona para `/`.\n\n**Fluxo:**\n1. Valida credencial (Base64 + MD5)\n2. Extrai dados: seqUsuario, seqOrgao, seqPerfil\n3. Busca dados do órgão + tribunal via corporativo-proxy\n4. Cria cookie `qadmin_session` (httpOnly, 8h TTL)\n5. Redireciona para `/`"
          },
          "response": [
            {
              "name": "302 - Login OK",
              "status": "Found",
              "code": 302,
              "header": [
                { "key": "Location", "value": "/" },
                { "key": "Set-Cookie", "value": "qadmin_session=eyJ...; Path=/; HttpOnly; SameSite=Lax" }
              ],
              "body": ""
            },
            {
              "name": "302 - Credencial inválida",
              "status": "Found",
              "code": 302,
              "header": [
                { "key": "Location", "value": "/auth/erro?msg=Credencial+inv%C3%A1lida+ou+expirada." }
              ],
              "body": ""
            }
          ]
        },
        {
          "name": "Login (callback credencial - POST)",
          "request": {
            "method": "POST",
            "header": [
              { "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
            ],
            "url": {
              "raw": "{{baseUrl}}/auth/callback",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "callback"]
            },
            "body": {
              "mode": "urlencoded",
              "urlencoded": [
                {
                  "key": "c",
                  "value": "CREDENCIAL_BASE64_AQUI",
                  "description": "Credencial corporativa CNJ"
                }
              ]
            },
            "description": "Mesmo callback, mas via POST. O portal CNJ pode enviar a credencial como form body."
          },
          "response": []
        },
        {
          "name": "Logout",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/auth/sair",
              "host": ["{{baseUrl}}"],
              "path": ["auth", "sair"]
            },
            "description": "Destrói a sessão do usuário e redireciona para o portal corporativo CNJ."
          },
          "response": [
            {
              "name": "302 - Sessão destruída",
              "status": "Found",
              "code": 302,
              "header": [
                { "key": "Location", "value": "{{corporativoUrl}}" },
                { "key": "Set-Cookie", "value": "qadmin_session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT" }
              ],
              "body": ""
            }
          ]
        }
      ]
    },
    {
      "name": "Corporativo",
      "description": "Endpoints para consulta de dados do sistema corporativo CNJ.\n\nTodos os endpoints requerem sessão ativa (cookie `qadmin_session`).\nDados são obtidos via corporativo-proxy (http://localhost:3001).",
      "item": [
        {
          "name": "Obter contexto do usuário",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/corporativo/contexto",
              "host": ["{{baseUrl}}"],
              "path": ["api", "corporativo", "contexto"]
            },
            "description": "Retorna o contexto completo do usuário logado: dados do usuário, órgão e tribunal.\n\nUsado para preencher perguntas ocultas (Expression Language) e avaliar filtros de visibilidade."
          },
          "response": [
            {
              "name": "200 - Contexto do usuário logado",
              "status": "OK",
              "code": 200,
              "header": [{ "key": "Content-Type", "value": "application/json" }],
              "body": "{\n  \"success\": true,\n  \"data\": {\n    \"usuario\": {\n      \"seqUsuario\": 123,\n      \"nomUsuario\": \"João da Silva\",\n      \"numCpf\": \"12345678901\",\n      \"dscEmail\": \"joao.silva@cnj.jus.br\",\n      \"seqOrgao\": 456,\n      \"cargo\": {\n        \"sigla\": \"AJAJ\",\n        \"descricao\": \"Analista Judiciário - Área Judiciária\"\n      }\n    },\n    \"orgao\": {\n      \"seqOrgao\": 456,\n      \"dscOrgao\": \"1ª Vara Criminal de São Paulo\",\n      \"seqOrgaoPai\": 1,\n      \"tipoOrgao\": {\n        \"codigo\": \"VARE\",\n        \"descricao\": \"Vara Estadual\"\n      },\n      \"tribunal\": {\n        \"seqOrgao\": 8,\n        \"nome\": \"Tribunal de Justiça do Estado de São Paulo\",\n        \"sigla\": \"TJSP\",\n        \"esfera\": \"ESTADUAL\",\n        \"ufs\": [\"SP\"]\n      }\n    },\n    \"tribunal\": {\n      \"seqOrgao\": 8,\n      \"nome\": \"Tribunal de Justiça do Estado de São Paulo\",\n      \"sigla\": \"TJSP\",\n      \"esfera\": \"ESTADUAL\",\n      \"ufs\": [\"SP\"]\n    }\n  }\n}"
            },
            {
              "name": "401 - Não autenticado",
              "status": "Unauthorized",
              "code": 401,
              "header": [{ "key": "Content-Type", "value": "application/json" }],
              "body": "{\n  \"error\": \"Não autenticado\"\n}"
            }
          ]
        },
        {
          "name": "Obter contexto de outro usuário (admin)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/corporativo/contexto?cpf=98765432100&orgao=456",
              "host": ["{{baseUrl}}"],
              "path": ["api", "corporativo", "contexto"],
              "query": [
                {
                  "key": "cpf",
                  "value": "98765432100",
                  "description": "CPF de outro usuário (apenas ADMINISTRADOR)"
                },
                {
                  "key": "orgao",
                  "value": "456",
                  "description": "SEQ_ORGAO do órgão desejado"
                }
              ]
            },
            "description": "Retorna o contexto de um usuário específico. **Requer perfil ADMINISTRADOR.**"
          },
          "response": [
            {
              "name": "403 - Sem permissão de admin",
              "status": "Forbidden",
              "code": 403,
              "header": [{ "key": "Content-Type", "value": "application/json" }],
              "body": "{\n  \"error\": \"Sem permissão para consultar outro usuário\"\n}"
            }
          ]
        },
        {
          "name": "Listar tribunais",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/api/corporativo/tribunais",
              "host": ["{{baseUrl}}"],
              "path": ["api", "corporativo", "tribunais"]
            },
            "description": "Lista todos os tribunais. **Requer sessão ativa.**"
          },
          "response": [
            {
              "name": "200 - Lista de tribunais",
              "status": "OK",
              "code": 200,
              "header": [{ "key": "Content-Type", "value": "application/json" }],
              "body": "{\n  \"success\": true,\n  \"data\": [\n    {\n      \"seqOrgao\": 8,\n      \"nome\": \"Tribunal de Justiça do Estado do Acre\",\n      \"sigla\": \"TJAC\",\n      \"esfera\": \"ESTADUAL\",\n      \"ufs\": [\"AC\"]\n    },\n    {\n      \"seqOrgao\": 3,\n      \"nome\": \"Tribunal Regional Federal da 1ª Região\",\n      \"sigla\": \"TRF1\",\n      \"esfera\": \"FEDERAL\",\n      \"ufs\": [\"AC\", \"AM\", \"AP\", \"BA\", \"DF\", \"GO\", \"MA\", \"MG\", \"MT\", \"PA\", \"PI\", \"RO\", \"RR\", \"TO\"]\n    }\n  ]\n}"
            },
            {
              "name": "401 - Não autenticado",
              "status": "Unauthorized",
              "code": 401,
              "header": [{ "key": "Content-Type", "value": "application/json" }],
              "body": "{\n  \"error\": \"Não autenticado\"\n}"
            }
          ]
        }
      ]
    }
  ]
}
